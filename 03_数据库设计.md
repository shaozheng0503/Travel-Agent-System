# æ—…æ¸¸Agentæ•°æ®åº“è®¾è®¡

## ğŸ“Š æ•°æ®åº“æ¶æ„

### æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MongoDB       â”‚    â”‚   Redis         â”‚    â”‚   æ–‡ä»¶å­˜å‚¨      â”‚
â”‚   (ä¸»æ•°æ®åº“)     â”‚    â”‚   (ç¼“å­˜å±‚)      â”‚    â”‚   (é™æ€èµ„æº)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - ç”¨æˆ·æ•°æ®      â”‚    â”‚ - ä¼šè¯ç¼“å­˜      â”‚    â”‚ - å›¾ç‰‡èµ„æº      â”‚
â”‚ - è¡Œç¨‹æ•°æ®      â”‚    â”‚ - çƒ­ç‚¹æ•°æ®      â”‚    â”‚ - æ–‡æ¡£æ–‡ä»¶      â”‚
â”‚ - å¯¹è¯å†å²      â”‚    â”‚ - ä¸´æ—¶æ•°æ®      â”‚    â”‚ - é…ç½®æ–‡ä»¶      â”‚
â”‚ - æ¨èæ•°æ®      â”‚    â”‚ - è®¡æ•°å™¨        â”‚    â”‚ - å¤‡ä»½æ–‡ä»¶      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘
```
ç”¨æˆ·è¯·æ±‚ â†’ Redisç¼“å­˜æ£€æŸ¥ â†’ MongoDBæŸ¥è¯¢ â†’ æ•°æ®æ›´æ–° â†’ Redisç¼“å­˜æ›´æ–° â†’ å“åº”è¿”å›
    â”‚           â”‚              â”‚           â”‚           â”‚           â”‚
    â–¼           â–¼              â–¼           â–¼           â–¼           â–¼
 è¯·æ±‚éªŒè¯    ç¼“å­˜å‘½ä¸­?       æ•°æ®æ“ä½œ    ç´¢å¼•æ›´æ–°    ç¼“å­˜å¤±æ•ˆ    ç»“æœæ ¼å¼åŒ–
```

## ğŸ—„ï¸ MongoDBé›†åˆè®¾è®¡

### 1. ç”¨æˆ·é›†åˆ (users)

#### é›†åˆç»“æ„
```javascript
{
  _id: ObjectId,
  userId: String,                    // ç”¨æˆ·å”¯ä¸€æ ‡è¯†
  username: String,                  // ç”¨æˆ·å
  email: String,                     // é‚®ç®±
  phone: String,                     // æ‰‹æœºå·
  avatar: String,                    // å¤´åƒURL
  status: String,                    // ç”¨æˆ·çŠ¶æ€: active, inactive, banned
  
  // ç”¨æˆ·åå¥½
  preferences: {
    travelStyle: String,             // æ—…è¡Œé£æ ¼: budget, luxury, adventure, cultural
    budgetRange: {
      min: Number,                   // æœ€å°é¢„ç®—
      max: Number                    // æœ€å¤§é¢„ç®—
    },
    interests: [String],             // å…´è¶£æ ‡ç­¾: ['culture', 'nature', 'food', 'shopping']
    preferredDestinations: [String], // åå¥½ç›®çš„åœ°
    preferredActivities: [String],   // åå¥½æ´»åŠ¨ç±»å‹
    dietaryRestrictions: [String],   // é¥®é£Ÿé™åˆ¶
    accessibility: Boolean,          // æ— éšœç¢éœ€æ±‚
    language: String                 // è¯­è¨€åå¥½
  },
  
  // ç”¨æˆ·è¡Œä¸ºæ•°æ®
  behavior: {
    lastLoginTime: Date,             // æœ€åç™»å½•æ—¶é—´
    loginCount: Number,              // ç™»å½•æ¬¡æ•°
    totalSessionTime: Number,        // æ€»ä¼šè¯æ—¶é•¿(åˆ†é’Ÿ)
    favoriteDestinations: [String],  // æ”¶è—çš„ç›®çš„åœ°
    completedTrips: Number,          // å®Œæˆçš„æ—…è¡Œæ¬¡æ•°
    averageRating: Number            // å¹³å‡è¯„åˆ†
  },
  
  // ç”¨æˆ·ç»Ÿè®¡
  statistics: {
    totalTrips: Number,              // æ€»æ—…è¡Œæ¬¡æ•°
    totalSpent: Number,              // æ€»èŠ±è´¹
    averageTripDuration: Number,     // å¹³å‡æ—…è¡Œæ—¶é•¿
    mostVisitedDestinations: [String], // æœ€å¸¸è®¿é—®çš„ç›®çš„åœ°
    preferredSeasons: [String]       // åå¥½å­£èŠ‚
  },
  
  // ç³»ç»Ÿå­—æ®µ
  createdAt: Date,                   // åˆ›å»ºæ—¶é—´
  updatedAt: Date,                   // æ›´æ–°æ—¶é—´
  lastActiveAt: Date,                // æœ€åæ´»è·ƒæ—¶é—´
  isVerified: Boolean,               // æ˜¯å¦å·²éªŒè¯
  verificationToken: String,         // éªŒè¯ä»¤ç‰Œ
  resetPasswordToken: String,        // é‡ç½®å¯†ç ä»¤ç‰Œ
  resetPasswordExpires: Date         // é‡ç½®å¯†ç è¿‡æœŸæ—¶é—´
}
```

#### ç´¢å¼•è®¾è®¡
```javascript
// ä¸»é”®ç´¢å¼•
db.users.createIndex({ "userId": 1 }, { unique: true })

// é‚®ç®±ç´¢å¼•
db.users.createIndex({ "email": 1 }, { unique: true })

// æ‰‹æœºå·ç´¢å¼•
db.users.createIndex({ "phone": 1 }, { sparse: true })

// ç”¨æˆ·åç´¢å¼•
db.users.createIndex({ "username": 1 }, { unique: true })

// å¤åˆç´¢å¼• - ç”¨æˆ·åå¥½æŸ¥è¯¢
db.users.createIndex({ 
  "preferences.travelStyle": 1, 
  "preferences.budgetRange.max": 1 
})

// å¤åˆç´¢å¼• - ç”¨æˆ·è¡Œä¸ºæŸ¥è¯¢
db.users.createIndex({ 
  "behavior.lastLoginTime": -1, 
  "status": 1 
})

// æ–‡æœ¬ç´¢å¼• - æœç´¢åŠŸèƒ½
db.users.createIndex({ 
  "username": "text", 
  "email": "text" 
})
```

### 2. å¯¹è¯å†å²é›†åˆ (conversations)

#### é›†åˆç»“æ„
```javascript
{
  _id: ObjectId,
  userId: ObjectId,                  // ç”¨æˆ·ID (å¼•ç”¨usersé›†åˆ)
  sessionId: String,                 // ä¼šè¯ID
  status: String,                    // ä¼šè¯çŠ¶æ€: active, completed, abandoned
  
  // ä¼šè¯ä¿¡æ¯
  sessionInfo: {
    startTime: Date,                 // å¼€å§‹æ—¶é—´
    endTime: Date,                   // ç»“æŸæ—¶é—´
    duration: Number,                // æŒç»­æ—¶é—´(ç§’)
    messageCount: Number,            // æ¶ˆæ¯æ•°é‡
    intentCount: Map,                // æ„å›¾ç»Ÿè®¡: {intent: count}
    entityCount: Map                 // å®ä½“ç»Ÿè®¡: {entity: count}
  },
  
  // æ¶ˆæ¯åˆ—è¡¨
  messages: [{
    messageId: String,               // æ¶ˆæ¯ID
    role: String,                    // è§’è‰²: user, assistant
    content: String,                 // æ¶ˆæ¯å†…å®¹
    timestamp: Date,                 // æ—¶é—´æˆ³
    intent: String,                  // è¯†åˆ«å‡ºçš„æ„å›¾
    entities: [{
      type: String,                  // å®ä½“ç±»å‹
      value: String,                 // å®ä½“å€¼
      confidence: Number,            // ç½®ä¿¡åº¦
      position: {
        start: Number,               // å¼€å§‹ä½ç½®
        end: Number                  // ç»“æŸä½ç½®
      }
    }],
    metadata: {
      responseTime: Number,          // å“åº”æ—¶é—´(æ¯«ç§’)
      tokens: Number,                // ä½¿ç”¨çš„tokenæ•°
      model: String,                 // ä½¿ç”¨çš„æ¨¡å‹
      cost: Number                   // æˆæœ¬
    }
  }],
  
  // ä¸Šä¸‹æ–‡ä¿¡æ¯
  context: {
    currentTrip: ObjectId,           // å½“å‰è¡Œç¨‹ID
    planningStage: String,           // è§„åˆ’é˜¶æ®µ
    userPreferences: Object,         // ç”¨æˆ·åå¥½å¿«ç…§
    extractedInfo: {
      destinations: [String],        // æå–çš„ç›®çš„åœ°
      dates: [Date],                 // æå–çš„æ—¥æœŸ
      budget: Number,                // æå–çš„é¢„ç®—
      people: Number,                // æå–çš„äººæ•°
      activities: [String]           // æå–çš„æ´»åŠ¨
    }
  },
  
  // ç³»ç»Ÿå­—æ®µ
  createdAt: Date,
  updatedAt: Date,
  expiresAt: Date                    // è¿‡æœŸæ—¶é—´(ç”¨äºè‡ªåŠ¨æ¸…ç†)
}
```

#### ç´¢å¼•è®¾è®¡
```javascript
// ä¸»é”®ç´¢å¼•
db.conversations.createIndex({ "_id": 1 })

// ç”¨æˆ·ä¼šè¯ç´¢å¼•
db.conversations.createIndex({ 
  "userId": 1, 
  "sessionId": 1 
}, { unique: true })

// æ—¶é—´èŒƒå›´æŸ¥è¯¢ç´¢å¼•
db.conversations.createIndex({ 
  "sessionInfo.startTime": -1, 
  "userId": 1 
})

// ä¼šè¯çŠ¶æ€ç´¢å¼•
db.conversations.createIndex({ 
  "status": 1, 
  "expiresAt": 1 
})

// æ„å›¾ç»Ÿè®¡ç´¢å¼•
db.conversations.createIndex({ 
  "sessionInfo.intentCount": 1 
})

// TTLç´¢å¼• - è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯
db.conversations.createIndex({ "expiresAt": 1 }, { expireAfterSeconds: 0 })
```

### 3. è¡Œç¨‹é›†åˆ (itineraries)

#### é›†åˆç»“æ„
```javascript
{
  _id: ObjectId,
  userId: ObjectId,                  // ç”¨æˆ·ID
  title: String,                     // è¡Œç¨‹æ ‡é¢˜
  description: String,               // è¡Œç¨‹æè¿°
  status: String,                    // çŠ¶æ€: draft, confirmed, completed, cancelled
  
  // è¡Œç¨‹åŸºæœ¬ä¿¡æ¯
  tripInfo: {
    destination: String,             // ç›®çš„åœ°
    startDate: Date,                 // å¼€å§‹æ—¥æœŸ
    endDate: Date,                   // ç»“æŸæ—¥æœŸ
    duration: Number,                // å¤©æ•°
    people: Number,                  // äººæ•°
    travelStyle: String,             // æ—…è¡Œé£æ ¼
    budget: {
      total: Number,                 // æ€»é¢„ç®—
      spent: Number,                 // å·²èŠ±è´¹
      currency: String               // è´§å¸å•ä½
    }
  },
  
  // æ¯æ—¥è¡Œç¨‹
  days: [{
    dayNumber: Number,               // ç¬¬å‡ å¤©
    date: Date,                      // æ—¥æœŸ
    weather: {
      condition: String,             // å¤©æ°”çŠ¶å†µ
      temperature: {
        min: Number,                 // æœ€ä½æ¸©åº¦
        max: Number                  // æœ€é«˜æ¸©åº¦
      },
      precipitation: Number,         // é™æ°´æ¦‚ç‡
      description: String            // å¤©æ°”æè¿°
    },
    activities: [{
      activityId: String,            // æ´»åŠ¨ID
      type: String,                  // æ´»åŠ¨ç±»å‹: attraction, restaurant, hotel, transport
      name: String,                  // æ´»åŠ¨åç§°
      location: {
        lat: Number,                 // çº¬åº¦
        lng: Number,                 // ç»åº¦
        address: String,             // åœ°å€
        placeId: String              // åœ°ç‚¹ID
      },
      startTime: String,             // å¼€å§‹æ—¶é—´
      endTime: String,               // ç»“æŸæ—¶é—´
      duration: Number,              // æŒç»­æ—¶é—´(åˆ†é’Ÿ)
      cost: Number,                  // è´¹ç”¨
      bookingInfo: {
        booked: Boolean,             // æ˜¯å¦å·²é¢„è®¢
        bookingId: String,           // é¢„è®¢ID
        confirmationCode: String,    // ç¡®è®¤ç 
        bookingUrl: String           // é¢„è®¢é“¾æ¥
      },
      notes: String,                 // å¤‡æ³¨
      rating: Number,                // è¯„åˆ†
      photos: [String],              // ç…§ç‰‡URL
      tags: [String]                 // æ ‡ç­¾
    }],
    totalCost: Number,               // å½“æ—¥æ€»è´¹ç”¨
    totalDistance: Number,           // å½“æ—¥æ€»è·ç¦»
    totalDuration: Number            // å½“æ—¥æ€»æ—¶é•¿
  }],
  
  // é¢„ç®—æ˜ç»†
  budgetBreakdown: {
    transportation: {
      total: Number,                 // äº¤é€šæ€»è´¹ç”¨
      breakdown: [{
        item: String,                // é¡¹ç›®åç§°
        amount: Number,              // é‡‘é¢
        date: Date,                  // æ—¥æœŸ
        notes: String                // å¤‡æ³¨
      }]
    },
    accommodation: {
      total: Number,                 // ä½å®¿æ€»è´¹ç”¨
      breakdown: [{
        hotel: String,               // é…’åº—åç§°
        amount: Number,              // é‡‘é¢
        nights: Number,              // ä½å®¿å¤©æ•°
        bookingInfo: Object          // é¢„è®¢ä¿¡æ¯
      }]
    },
    food: {
      total: Number,                 // é¤é¥®æ€»è´¹ç”¨
      breakdown: [{
        meal: String,                // é¤æ¬¡
        amount: Number,              // é‡‘é¢
        date: Date,                  // æ—¥æœŸ
        restaurant: String           // é¤å…åç§°
      }]
    },
    activities: {
      total: Number,                 // æ´»åŠ¨æ€»è´¹ç”¨
      breakdown: [{
        activity: String,            // æ´»åŠ¨åç§°
        amount: Number,              // é‡‘é¢
        date: Date,                  // æ—¥æœŸ
        tickets: Number              // ç¥¨æ•°
      }]
    },
    shopping: {
      total: Number,                 // è´­ç‰©æ€»è´¹ç”¨
      breakdown: [{
        item: String,                // å•†å“åç§°
        amount: Number,              // é‡‘é¢
        date: Date,                  // æ—¥æœŸ
        category: String             // å•†å“ç±»åˆ«
      }]
    }
  },
  
  // è·¯çº¿ä¿¡æ¯
  routes: [{
    routeId: String,                 // è·¯çº¿ID
    dayNumber: Number,               // å¯¹åº”å¤©æ•°
    startLocation: {
      lat: Number,
      lng: Number,
      address: String
    },
    endLocation: {
      lat: Number,
      lng: Number,
      address: String
    },
    waypoints: [{
      lat: Number,
      lng: Number,
      address: String,
      activityId: String
    }],
    transportMode: String,           // äº¤é€šæ–¹å¼
    distance: Number,                // è·ç¦»(ç±³)
    duration: Number,                // æ—¶é•¿(ç§’)
    cost: Number,                    // è´¹ç”¨
    polyline: [[Number, Number]],    // è·¯çº¿åæ ‡
    trafficInfo: {
      congestion: String,            // æ‹¥å µç¨‹åº¦
      delay: Number,                 // å»¶è¿Ÿæ—¶é—´
      speed: Number                  // å¹³å‡é€Ÿåº¦
    }
  }],
  
  // ç³»ç»Ÿå­—æ®µ
  createdAt: Date,
  updatedAt: Date,
  lastModifiedBy: ObjectId,          // æœ€åä¿®æ”¹è€…
  version: Number,                   // ç‰ˆæœ¬å·
  isPublic: Boolean,                 // æ˜¯å¦å…¬å¼€
  tags: [String]                     // æ ‡ç­¾
}
```

#### ç´¢å¼•è®¾è®¡
```javascript
// ä¸»é”®ç´¢å¼•
db.itineraries.createIndex({ "_id": 1 })

// ç”¨æˆ·è¡Œç¨‹ç´¢å¼•
db.itineraries.createIndex({ 
  "userId": 1, 
  "createdAt": -1 
})

// ç›®çš„åœ°æŸ¥è¯¢ç´¢å¼•
db.itineraries.createIndex({ 
  "tripInfo.destination": 1, 
  "status": 1 
})

// æ—¥æœŸèŒƒå›´æŸ¥è¯¢ç´¢å¼•
db.itineraries.createIndex({ 
  "tripInfo.startDate": 1, 
  "tripInfo.endDate": 1 
})

// çŠ¶æ€æŸ¥è¯¢ç´¢å¼•
db.itineraries.createIndex({ 
  "status": 1, 
  "updatedAt": -1 
})

// é¢„ç®—èŒƒå›´æŸ¥è¯¢ç´¢å¼•
db.itineraries.createIndex({ 
  "tripInfo.budget.total": 1, 
  "tripInfo.duration": 1 
})

// å¤åˆç´¢å¼• - æ¨èæŸ¥è¯¢
db.itineraries.createIndex({ 
  "tripInfo.destination": 1, 
  "tripInfo.travelStyle": 1, 
  "status": 1 
})

// æ–‡æœ¬ç´¢å¼• - æœç´¢åŠŸèƒ½
db.itineraries.createIndex({ 
  "title": "text", 
  "description": "text", 
  "tripInfo.destination": "text" 
})
```

### 4. æ™¯ç‚¹é›†åˆ (attractions)

#### é›†åˆç»“æ„
```javascript
{
  _id: ObjectId,
  attractionId: String,              // æ™¯ç‚¹å”¯ä¸€æ ‡è¯†
  name: String,                      // æ™¯ç‚¹åç§°
  nameEn: String,                    // è‹±æ–‡åç§°
  category: String,                  // ç±»åˆ«: museum, park, landmark, restaurant, etc.
  subcategory: String,               // å­ç±»åˆ«
  
  // ä½ç½®ä¿¡æ¯
  location: {
    lat: Number,                     // çº¬åº¦
    lng: Number,                     // ç»åº¦
    address: String,                 // åœ°å€
    city: String,                    // åŸå¸‚
    province: String,                // çœä»½
    country: String,                 // å›½å®¶
    postalCode: String,              // é‚®ç¼–
    placeId: String                  // åœ°ç‚¹ID
  },
  
  // åŸºæœ¬ä¿¡æ¯
  basicInfo: {
    description: String,             // æè¿°
    shortDescription: String,        // ç®€çŸ­æè¿°
    openingHours: [{
      day: String,                   // æ˜ŸæœŸå‡ 
      open: String,                  // å¼€é—¨æ—¶é—´
      close: String,                 // å…³é—¨æ—¶é—´
      isOpen: Boolean                // æ˜¯å¦è¥ä¸š
    }],
    phone: String,                   // ç”µè¯
    website: String,                 // ç½‘ç«™
    email: String,                   // é‚®ç®±
    price: {
      amount: Number,                // ä»·æ ¼
      currency: String,              // è´§å¸
      type: String                   // ä»·æ ¼ç±»å‹: free, paid, donation
    },
    duration: Number,                // å»ºè®®æ¸¸è§ˆæ—¶é•¿(åˆ†é’Ÿ)
    capacity: Number,                // å®¹é‡
    ageRestriction: {
      min: Number,                   // æœ€å°å¹´é¾„
      max: Number                    // æœ€å¤§å¹´é¾„
    }
  },
  
  // è¯„åˆ†å’Œè¯„è®º
  ratings: {
    average: Number,                 // å¹³å‡è¯„åˆ†
    count: Number,                   // è¯„åˆ†æ•°é‡
    distribution: {                  // è¯„åˆ†åˆ†å¸ƒ
      "1": Number,
      "2": Number,
      "3": Number,
      "4": Number,
      "5": Number
    },
    recentReviews: [{
      userId: ObjectId,              // ç”¨æˆ·ID
      rating: Number,                // è¯„åˆ†
      comment: String,               // è¯„è®º
      date: Date,                    // è¯„è®ºæ—¥æœŸ
      helpful: Number                // æœ‰ç”¨æ•°
    }]
  },
  
  // åª’ä½“èµ„æº
  media: {
    images: [{
      url: String,                   // å›¾ç‰‡URL
      caption: String,               // å›¾ç‰‡è¯´æ˜
      type: String,                  // å›¾ç‰‡ç±»å‹: main, gallery, thumbnail
      width: Number,                 // å®½åº¦
      height: Number                 // é«˜åº¦
    }],
    videos: [{
      url: String,                   // è§†é¢‘URL
      caption: String,               // è§†é¢‘è¯´æ˜
      duration: Number,              // æ—¶é•¿(ç§’)
      thumbnail: String              // ç¼©ç•¥å›¾URL
    }],
    virtualTour: String              // è™šæ‹Ÿå¯¼è§ˆURL
  },
  
  // ç‰¹è‰²å’Œè®¾æ–½
  features: {
    tags: [String],                  // æ ‡ç­¾
    amenities: [String],             // è®¾æ–½
    accessibility: [String],         // æ— éšœç¢è®¾æ–½
    languages: [String],             // æ”¯æŒè¯­è¨€
    paymentMethods: [String],        // æ”¯ä»˜æ–¹å¼
    parking: {
      available: Boolean,            // æ˜¯å¦æœ‰åœè½¦åœº
      type: String,                  // åœè½¦ç±»å‹: free, paid, valet
      cost: Number                   // åœè½¦è´¹ç”¨
    }
  },
  
  // å­£èŠ‚æ€§ä¿¡æ¯
  seasonalInfo: {
    bestTime: [String],              // æœ€ä½³æ—¶é—´
    peakSeason: {
      start: String,                 // æ—ºå­£å¼€å§‹
      end: String                    // æ—ºå­£ç»“æŸ
    },
    weatherConsiderations: String,   // å¤©æ°”è€ƒè™‘
    specialEvents: [{
      name: String,                  // æ´»åŠ¨åç§°
      date: String,                  // æ´»åŠ¨æ—¥æœŸ
      description: String            // æ´»åŠ¨æè¿°
    }]
  },
  
  // æ¨èä¿¡æ¯
  recommendations: {
    similarAttractions: [ObjectId],  // ç›¸ä¼¼æ™¯ç‚¹
    nearbyAttractions: [ObjectId],   // é™„è¿‘æ™¯ç‚¹
    popularCombinations: [ObjectId], // çƒ­é—¨ç»„åˆ
    userRecommendations: [{
      userId: ObjectId,              // ç”¨æˆ·ID
      reason: String,                // æ¨èç†ç”±
      date: Date                     // æ¨èæ—¥æœŸ
    }]
  },
  
  // ç»Ÿè®¡æ•°æ®
  statistics: {
    viewCount: Number,               // æµè§ˆæ¬¡æ•°
    favoriteCount: Number,           // æ”¶è—æ¬¡æ•°
    visitCount: Number,              // è®¿é—®æ¬¡æ•°
    averageVisitDuration: Number,    // å¹³å‡è®¿é—®æ—¶é•¿
    popularTimes: [{
      day: String,                   // æ˜ŸæœŸå‡ 
      hour: Number,                  // å°æ—¶
      popularity: Number             // çƒ­é—¨ç¨‹åº¦(0-100)
    }]
  },
  
  // ç³»ç»Ÿå­—æ®µ
  createdAt: Date,
  updatedAt: Date,
  lastVerified: Date,                // æœ€åéªŒè¯æ—¶é—´
  isActive: Boolean,                 // æ˜¯å¦æ´»è·ƒ
  source: String,                    // æ•°æ®æ¥æº
  version: Number                    // ç‰ˆæœ¬å·
}
```

#### ç´¢å¼•è®¾è®¡
```javascript
// ä¸»é”®ç´¢å¼•
db.attractions.createIndex({ "_id": 1 })

// æ™¯ç‚¹IDç´¢å¼•
db.attractions.createIndex({ "attractionId": 1 }, { unique: true })

// åœ°ç†ä½ç½®ç´¢å¼•
db.attractions.createIndex({ 
  "location": "2dsphere" 
})

// åŸå¸‚æŸ¥è¯¢ç´¢å¼•
db.attractions.createIndex({ 
  "location.city": 1, 
  "category": 1 
})

// ç±»åˆ«æŸ¥è¯¢ç´¢å¼•
db.attractions.createIndex({ 
  "category": 1, 
  "subcategory": 1 
})

// è¯„åˆ†æŸ¥è¯¢ç´¢å¼•
db.attractions.createIndex({ 
  "ratings.average": -1, 
  "ratings.count": -1 
})

// ä»·æ ¼æŸ¥è¯¢ç´¢å¼•
db.attractions.createIndex({ 
  "basicInfo.price.amount": 1, 
  "basicInfo.price.type": 1 
})

// æ ‡ç­¾æŸ¥è¯¢ç´¢å¼•
db.attractions.createIndex({ 
  "features.tags": 1 
})

// æ–‡æœ¬æœç´¢ç´¢å¼•
db.attractions.createIndex({ 
  "name": "text", 
  "nameEn": "text", 
  "basicInfo.description": "text" 
})

// å¤åˆç´¢å¼• - æ¨èæŸ¥è¯¢
db.attractions.createIndex({ 
  "location.city": 1, 
  "category": 1, 
  "ratings.average": -1, 
  "isActive": 1 
})
```

## ğŸ”„ Redisç¼“å­˜è®¾è®¡

### 1. ç¼“å­˜ç­–ç•¥

#### ç¼“å­˜å±‚çº§
```javascript
// L1ç¼“å­˜ - å†…å­˜ç¼“å­˜ (åº”ç”¨å±‚)
const memoryCache = new Map();

// L2ç¼“å­˜ - Redisç¼“å­˜ (åˆ†å¸ƒå¼ç¼“å­˜)
const redisClient = redis.createClient();

// L3ç¼“å­˜ - æ•°æ®åº“ (æŒä¹…åŒ–å­˜å‚¨)
const mongoClient = new MongoClient();
```

#### ç¼“å­˜é”®è®¾è®¡
```javascript
// ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
const userCacheKey = `user:${userId}`;
const userProfileCacheKey = `user:${userId}:profile`;

// ä¼šè¯ç¼“å­˜
const sessionCacheKey = `session:${sessionId}`;
const conversationCacheKey = `conversation:${sessionId}`;

// è¡Œç¨‹ç¼“å­˜
const itineraryCacheKey = `itinerary:${itineraryId}`;
const userItinerariesCacheKey = `user:${userId}:itineraries`;

// æ™¯ç‚¹ç¼“å­˜
const attractionCacheKey = `attraction:${attractionId}`;
const attractionsByCityCacheKey = `attractions:city:${city}`;
const attractionsByCategoryCacheKey = `attractions:category:${category}`;

// æ¨èç¼“å­˜
const recommendationsCacheKey = `recommendations:${userId}:${location}`;
const popularAttractionsCacheKey = `popular:attractions:${city}`;

// å¤©æ°”ç¼“å­˜
const weatherCacheKey = `weather:${city}:${date}`;

// è·¯çº¿ç¼“å­˜
const routeCacheKey = `route:${startPoint}:${endPoint}:${mode}`;
```

### 2. ç¼“å­˜æ•°æ®ç»“æ„

#### ç”¨æˆ·ä¼šè¯ç¼“å­˜
```javascript
// Redis Hashç»“æ„
{
  "session:abc123": {
    "userId": "user123",
    "sessionId": "abc123",
    "startTime": "2024-12-01T10:00:00Z",
    "lastActivity": "2024-12-01T10:30:00Z",
    "messageCount": "15",
    "currentIntent": "plan_trip",
    "planningStage": "destination_selection",
    "extractedEntities": '{"location": ["åŒ—äº¬"], "duration": ["3å¤©"]}',
    "userPreferences": '{"travelStyle": "budget", "budgetRange": {"min": 1000, "max": 5000}}'
  }
}
```

#### å¯¹è¯æ¶ˆæ¯ç¼“å­˜
```javascript
// Redis Listç»“æ„
{
  "conversation:abc123": [
    '{"role": "user", "content": "æˆ‘æƒ³å»åŒ—äº¬æ—…æ¸¸", "timestamp": "2024-12-01T10:00:00Z"}',
    '{"role": "assistant", "content": "å¥½çš„ï¼Œæˆ‘æ¥å¸®æ‚¨è§„åˆ’åŒ—äº¬ä¹‹æ—…", "timestamp": "2024-12-01T10:00:05Z"}',
    '{"role": "user", "content": "é¢„ç®—3000å…ƒ", "timestamp": "2024-12-01T10:01:00Z"}'
  ]
}
```

#### æ™¯ç‚¹ä¿¡æ¯ç¼“å­˜
```javascript
// Redis Hashç»“æ„
{
  "attraction:beijing_forbidden_city": {
    "id": "beijing_forbidden_city",
    "name": "æ•…å®«åšç‰©é™¢",
    "category": "museum",
    "location": '{"lat": 39.9163, "lng": 116.3972, "city": "åŒ—äº¬"}',
    "rating": "4.8",
    "price": "60",
    "openingHours": '{"monday": {"open": "08:30", "close": "17:00"}}',
    "description": "ä¸­å›½æ˜æ¸…ä¸¤ä»£çš„çš‡å®¶å®«æ®¿",
    "images": '["image1.jpg", "image2.jpg"]',
    "tags": '["å†å²", "æ–‡åŒ–", "å»ºç­‘"]'
  }
}
```

#### æ¨èç»“æœç¼“å­˜
```javascript
// Redis Sorted Setç»“æ„
{
  "recommendations:user123:beijing": [
    {"score": "0.95", "member": "attraction:beijing_forbidden_city"},
    {"score": "0.92", "member": "attraction:beijing_summer_palace"},
    {"score": "0.88", "member": "attraction:beijing_temple_of_heaven"}
  ]
}
```

### 3. ç¼“å­˜ç®¡ç†ç­–ç•¥

#### TTLè®¾ç½®
```javascript
const CACHE_TTL = {
  // çŸ­æœŸç¼“å­˜ (5åˆ†é’Ÿ)
  SHORT: 300,
  
  // ä¸­æœŸç¼“å­˜ (1å°æ—¶)
  MEDIUM: 3600,
  
  // é•¿æœŸç¼“å­˜ (24å°æ—¶)
  LONG: 86400,
  
  // è¶…é•¿æœŸç¼“å­˜ (7å¤©)
  EXTENDED: 604800,
  
  // å…·ä½“ä¸šåŠ¡TTL
  USER_SESSION: 1800,           // 30åˆ†é’Ÿ
  CONVERSATION: 3600,           // 1å°æ—¶
  ITINERARY: 86400,             // 24å°æ—¶
  ATTRACTION: 604800,           // 7å¤©
  RECOMMENDATIONS: 3600,        // 1å°æ—¶
  WEATHER: 1800,                // 30åˆ†é’Ÿ
  ROUTE: 3600                   // 1å°æ—¶
};
```

#### ç¼“å­˜æ›´æ–°ç­–ç•¥
```javascript
class CacheManager {
  // å†™å…¥æ—¶æ›´æ–°ç¼“å­˜
  async updateCache(key: string, data: any, ttl: number): Promise<void> {
    await this.redis.setex(key, ttl, JSON.stringify(data));
  }
  
  // åˆ é™¤ç¼“å­˜
  async invalidateCache(pattern: string): Promise<void> {
    const keys = await this.redis.keys(pattern);
    if (keys.length > 0) {
      await this.redis.del(...keys);
    }
  }
  
  // æ‰¹é‡æ›´æ–°ç¼“å­˜
  async batchUpdateCache(updates: Array<{key: string, data: any, ttl: number}>): Promise<void> {
    const pipeline = this.redis.pipeline();
    
    updates.forEach(({key, data, ttl}) => {
      pipeline.setex(key, ttl, JSON.stringify(data));
    });
    
    await pipeline.exec();
  }
  
  // ç¼“å­˜é¢„çƒ­
  async warmupCache(): Promise<void> {
    // é¢„çƒ­çƒ­é—¨æ™¯ç‚¹
    const popularAttractions = await this.getPopularAttractions();
    await this.updateCache('popular:attractions', popularAttractions, CACHE_TTL.LONG);
    
    // é¢„çƒ­åŸå¸‚ä¿¡æ¯
    const cities = await this.getCities();
    await this.updateCache('cities:list', cities, CACHE_TTL.EXTENDED);
  }
}
```

#### ç¼“å­˜ä¸€è‡´æ€§
```javascript
class CacheConsistencyManager {
  // æ•°æ®åº“æ›´æ–°æ—¶åŒæ­¥ç¼“å­˜
  async syncCacheOnUpdate(collection: string, documentId: string): Promise<void> {
    const cacheKey = `${collection}:${documentId}`;
    
    // åˆ é™¤ç›¸å…³ç¼“å­˜
    await this.cacheManager.invalidateCache(cacheKey);
    
    // åˆ é™¤ç›¸å…³æŸ¥è¯¢ç¼“å­˜
    const relatedPatterns = this.getRelatedCachePatterns(collection, documentId);
    for (const pattern of relatedPatterns) {
      await this.cacheManager.invalidateCache(pattern);
    }
  }
  
  // è·å–ç›¸å…³ç¼“å­˜æ¨¡å¼
  private getRelatedCachePatterns(collection: string, documentId: string): string[] {
    const patterns = [];
    
    switch (collection) {
      case 'users':
        patterns.push(`user:${documentId}:*`);
        patterns.push(`recommendations:${documentId}:*`);
        break;
      case 'itineraries':
        patterns.push(`itinerary:${documentId}`);
        patterns.push(`user:*:itineraries`);
        break;
      case 'attractions':
        patterns.push(`attraction:${documentId}`);
        patterns.push(`attractions:city:*`);
        patterns.push(`attractions:category:*`);
        patterns.push(`popular:attractions:*`);
        break;
    }
    
    return patterns;
  }
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

#### æŸ¥è¯¢ä¼˜åŒ–
```javascript
// ä½¿ç”¨èšåˆç®¡é“ä¼˜åŒ–å¤æ‚æŸ¥è¯¢
const optimizedQuery = db.itineraries.aggregate([
  // åŒ¹é…æ¡ä»¶
  { $match: { 
    userId: ObjectId(userId),
    status: { $in: ['confirmed', 'completed'] }
  }},
  
  // å…³è”ç”¨æˆ·ä¿¡æ¯
  { $lookup: {
    from: 'users',
    localField: 'userId',
    foreignField: '_id',
    as: 'user'
  }},
  
  // å±•å¼€ç”¨æˆ·æ•°ç»„
  { $unwind: '$user' },
  
  // æŠ•å½±éœ€è¦çš„å­—æ®µ
  { $project: {
    title: 1,
    destination: '$tripInfo.destination',
    startDate: '$tripInfo.startDate',
    endDate: '$tripInfo.endDate',
    budget: '$tripInfo.budget.total',
    username: '$user.username'
  }},
  
  // æ’åº
  { $sort: { startDate: -1 }},
  
  // é™åˆ¶ç»“æœæ•°é‡
  { $limit: 20 }
]);
```

#### ç´¢å¼•ä¼˜åŒ–
```javascript
// å¤åˆç´¢å¼•ä¼˜åŒ–
db.itineraries.createIndex({
  "userId": 1,
  "status": 1,
  "tripInfo.startDate": -1
}, { background: true });

// éƒ¨åˆ†ç´¢å¼• - åªç´¢å¼•æ´»è·ƒç”¨æˆ·
db.users.createIndex(
  { "status": 1, "lastActiveAt": -1 },
  { 
    partialFilterExpression: { status: "active" },
    background: true 
  }
);

// ç¨€ç–ç´¢å¼• - åªç´¢å¼•æœ‰å€¼çš„å­—æ®µ
db.attractions.createIndex(
  { "basicInfo.phone": 1 },
  { sparse: true, background: true }
);
```

### 2. ç¼“å­˜ä¼˜åŒ–

#### ç¼“å­˜å‘½ä¸­ç‡ä¼˜åŒ–
```javascript
class CacheOptimizer {
  // é¢„æµ‹æ€§ç¼“å­˜
  async predictiveCache(userId: string): Promise<void> {
    const userBehavior = await this.analyzeUserBehavior(userId);
    
    // ç¼“å­˜ç”¨æˆ·å¯èƒ½è®¿é—®çš„æ•°æ®
    if (userBehavior.frequentlySearchedCities.length > 0) {
      for (const city of userBehavior.frequentlySearchedCities) {
        await this.cacheCityAttractions(city);
      }
    }
    
    // ç¼“å­˜ç”¨æˆ·åå¥½çš„æ™¯ç‚¹ç±»åˆ«
    if (userBehavior.preferredCategories.length > 0) {
      for (const category of userBehavior.preferredCategories) {
        await this.cacheCategoryAttractions(category);
      }
    }
  }
  
  // æ™ºèƒ½ç¼“å­˜å¤±æ•ˆ
  async smartCacheInvalidation(changeType: string, data: any): Promise<void> {
    switch (changeType) {
      case 'user_preference_update':
        await this.invalidateUserRecommendations(data.userId);
        break;
      case 'attraction_update':
        await this.invalidateAttractionCache(data.attractionId);
        await this.invalidateRelatedCaches(data.attractionId);
        break;
      case 'itinerary_update':
        await this.invalidateItineraryCache(data.itineraryId);
        await this.invalidateUserItineraries(data.userId);
        break;
    }
  }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024å¹´12æœˆ  
**ç»´æŠ¤è€…**: æ•°æ®åº“è®¾è®¡å›¢é˜Ÿ 