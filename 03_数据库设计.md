# 旅游Agent数据库设计

## 📊 数据库架构

### 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MongoDB       │    │   Redis         │    │   文件存储      │
│   (主数据库)     │    │   (缓存层)      │    │   (静态资源)    │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ - 用户数据      │    │ - 会话缓存      │    │ - 图片资源      │
│ - 行程数据      │    │ - 热点数据      │    │ - 文档文件      │
│ - 对话历史      │    │ - 临时数据      │    │ - 配置文件      │
│ - 推荐数据      │    │ - 计数器        │    │ - 备份文件      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 数据流向
```
用户请求 → Redis缓存检查 → MongoDB查询 → 数据更新 → Redis缓存更新 → 响应返回
    │           │              │           │           │           │
    ▼           ▼              ▼           ▼           ▼           ▼
 请求验证    缓存命中?       数据操作    索引更新    缓存失效    结果格式化
```

## 🗄️ MongoDB集合设计

### 1. 用户集合 (users)

#### 集合结构
```javascript
{
  _id: ObjectId,
  userId: String,                    // 用户唯一标识
  username: String,                  // 用户名
  email: String,                     // 邮箱
  phone: String,                     // 手机号
  avatar: String,                    // 头像URL
  status: String,                    // 用户状态: active, inactive, banned
  
  // 用户偏好
  preferences: {
    travelStyle: String,             // 旅行风格: budget, luxury, adventure, cultural
    budgetRange: {
      min: Number,                   // 最小预算
      max: Number                    // 最大预算
    },
    interests: [String],             // 兴趣标签: ['culture', 'nature', 'food', 'shopping']
    preferredDestinations: [String], // 偏好目的地
    preferredActivities: [String],   // 偏好活动类型
    dietaryRestrictions: [String],   // 饮食限制
    accessibility: Boolean,          // 无障碍需求
    language: String                 // 语言偏好
  },
  
  // 用户行为数据
  behavior: {
    lastLoginTime: Date,             // 最后登录时间
    loginCount: Number,              // 登录次数
    totalSessionTime: Number,        // 总会话时长(分钟)
    favoriteDestinations: [String],  // 收藏的目的地
    completedTrips: Number,          // 完成的旅行次数
    averageRating: Number            // 平均评分
  },
  
  // 用户统计
  statistics: {
    totalTrips: Number,              // 总旅行次数
    totalSpent: Number,              // 总花费
    averageTripDuration: Number,     // 平均旅行时长
    mostVisitedDestinations: [String], // 最常访问的目的地
    preferredSeasons: [String]       // 偏好季节
  },
  
  // 系统字段
  createdAt: Date,                   // 创建时间
  updatedAt: Date,                   // 更新时间
  lastActiveAt: Date,                // 最后活跃时间
  isVerified: Boolean,               // 是否已验证
  verificationToken: String,         // 验证令牌
  resetPasswordToken: String,        // 重置密码令牌
  resetPasswordExpires: Date         // 重置密码过期时间
}
```

#### 索引设计
```javascript
// 主键索引
db.users.createIndex({ "userId": 1 }, { unique: true })

// 邮箱索引
db.users.createIndex({ "email": 1 }, { unique: true })

// 手机号索引
db.users.createIndex({ "phone": 1 }, { sparse: true })

// 用户名索引
db.users.createIndex({ "username": 1 }, { unique: true })

// 复合索引 - 用户偏好查询
db.users.createIndex({ 
  "preferences.travelStyle": 1, 
  "preferences.budgetRange.max": 1 
})

// 复合索引 - 用户行为查询
db.users.createIndex({ 
  "behavior.lastLoginTime": -1, 
  "status": 1 
})

// 文本索引 - 搜索功能
db.users.createIndex({ 
  "username": "text", 
  "email": "text" 
})
```

### 2. 对话历史集合 (conversations)

#### 集合结构
```javascript
{
  _id: ObjectId,
  userId: ObjectId,                  // 用户ID (引用users集合)
  sessionId: String,                 // 会话ID
  status: String,                    // 会话状态: active, completed, abandoned
  
  // 会话信息
  sessionInfo: {
    startTime: Date,                 // 开始时间
    endTime: Date,                   // 结束时间
    duration: Number,                // 持续时间(秒)
    messageCount: Number,            // 消息数量
    intentCount: Map,                // 意图统计: {intent: count}
    entityCount: Map                 // 实体统计: {entity: count}
  },
  
  // 消息列表
  messages: [{
    messageId: String,               // 消息ID
    role: String,                    // 角色: user, assistant
    content: String,                 // 消息内容
    timestamp: Date,                 // 时间戳
    intent: String,                  // 识别出的意图
    entities: [{
      type: String,                  // 实体类型
      value: String,                 // 实体值
      confidence: Number,            // 置信度
      position: {
        start: Number,               // 开始位置
        end: Number                  // 结束位置
      }
    }],
    metadata: {
      responseTime: Number,          // 响应时间(毫秒)
      tokens: Number,                // 使用的token数
      model: String,                 // 使用的模型
      cost: Number                   // 成本
    }
  }],
  
  // 上下文信息
  context: {
    currentTrip: ObjectId,           // 当前行程ID
    planningStage: String,           // 规划阶段
    userPreferences: Object,         // 用户偏好快照
    extractedInfo: {
      destinations: [String],        // 提取的目的地
      dates: [Date],                 // 提取的日期
      budget: Number,                // 提取的预算
      people: Number,                // 提取的人数
      activities: [String]           // 提取的活动
    }
  },
  
  // 系统字段
  createdAt: Date,
  updatedAt: Date,
  expiresAt: Date                    // 过期时间(用于自动清理)
}
```

#### 索引设计
```javascript
// 主键索引
db.conversations.createIndex({ "_id": 1 })

// 用户会话索引
db.conversations.createIndex({ 
  "userId": 1, 
  "sessionId": 1 
}, { unique: true })

// 时间范围查询索引
db.conversations.createIndex({ 
  "sessionInfo.startTime": -1, 
  "userId": 1 
})

// 会话状态索引
db.conversations.createIndex({ 
  "status": 1, 
  "expiresAt": 1 
})

// 意图统计索引
db.conversations.createIndex({ 
  "sessionInfo.intentCount": 1 
})

// TTL索引 - 自动清理过期会话
db.conversations.createIndex({ "expiresAt": 1 }, { expireAfterSeconds: 0 })
```

### 3. 行程集合 (itineraries)

#### 集合结构
```javascript
{
  _id: ObjectId,
  userId: ObjectId,                  // 用户ID
  title: String,                     // 行程标题
  description: String,               // 行程描述
  status: String,                    // 状态: draft, confirmed, completed, cancelled
  
  // 行程基本信息
  tripInfo: {
    destination: String,             // 目的地
    startDate: Date,                 // 开始日期
    endDate: Date,                   // 结束日期
    duration: Number,                // 天数
    people: Number,                  // 人数
    travelStyle: String,             // 旅行风格
    budget: {
      total: Number,                 // 总预算
      spent: Number,                 // 已花费
      currency: String               // 货币单位
    }
  },
  
  // 每日行程
  days: [{
    dayNumber: Number,               // 第几天
    date: Date,                      // 日期
    weather: {
      condition: String,             // 天气状况
      temperature: {
        min: Number,                 // 最低温度
        max: Number                  // 最高温度
      },
      precipitation: Number,         // 降水概率
      description: String            // 天气描述
    },
    activities: [{
      activityId: String,            // 活动ID
      type: String,                  // 活动类型: attraction, restaurant, hotel, transport
      name: String,                  // 活动名称
      location: {
        lat: Number,                 // 纬度
        lng: Number,                 // 经度
        address: String,             // 地址
        placeId: String              // 地点ID
      },
      startTime: String,             // 开始时间
      endTime: String,               // 结束时间
      duration: Number,              // 持续时间(分钟)
      cost: Number,                  // 费用
      bookingInfo: {
        booked: Boolean,             // 是否已预订
        bookingId: String,           // 预订ID
        confirmationCode: String,    // 确认码
        bookingUrl: String           // 预订链接
      },
      notes: String,                 // 备注
      rating: Number,                // 评分
      photos: [String],              // 照片URL
      tags: [String]                 // 标签
    }],
    totalCost: Number,               // 当日总费用
    totalDistance: Number,           // 当日总距离
    totalDuration: Number            // 当日总时长
  }],
  
  // 预算明细
  budgetBreakdown: {
    transportation: {
      total: Number,                 // 交通总费用
      breakdown: [{
        item: String,                // 项目名称
        amount: Number,              // 金额
        date: Date,                  // 日期
        notes: String                // 备注
      }]
    },
    accommodation: {
      total: Number,                 // 住宿总费用
      breakdown: [{
        hotel: String,               // 酒店名称
        amount: Number,              // 金额
        nights: Number,              // 住宿天数
        bookingInfo: Object          // 预订信息
      }]
    },
    food: {
      total: Number,                 // 餐饮总费用
      breakdown: [{
        meal: String,                // 餐次
        amount: Number,              // 金额
        date: Date,                  // 日期
        restaurant: String           // 餐厅名称
      }]
    },
    activities: {
      total: Number,                 // 活动总费用
      breakdown: [{
        activity: String,            // 活动名称
        amount: Number,              // 金额
        date: Date,                  // 日期
        tickets: Number              // 票数
      }]
    },
    shopping: {
      total: Number,                 // 购物总费用
      breakdown: [{
        item: String,                // 商品名称
        amount: Number,              // 金额
        date: Date,                  // 日期
        category: String             // 商品类别
      }]
    }
  },
  
  // 路线信息
  routes: [{
    routeId: String,                 // 路线ID
    dayNumber: Number,               // 对应天数
    startLocation: {
      lat: Number,
      lng: Number,
      address: String
    },
    endLocation: {
      lat: Number,
      lng: Number,
      address: String
    },
    waypoints: [{
      lat: Number,
      lng: Number,
      address: String,
      activityId: String
    }],
    transportMode: String,           // 交通方式
    distance: Number,                // 距离(米)
    duration: Number,                // 时长(秒)
    cost: Number,                    // 费用
    polyline: [[Number, Number]],    // 路线坐标
    trafficInfo: {
      congestion: String,            // 拥堵程度
      delay: Number,                 // 延迟时间
      speed: Number                  // 平均速度
    }
  }],
  
  // 系统字段
  createdAt: Date,
  updatedAt: Date,
  lastModifiedBy: ObjectId,          // 最后修改者
  version: Number,                   // 版本号
  isPublic: Boolean,                 // 是否公开
  tags: [String]                     // 标签
}
```

#### 索引设计
```javascript
// 主键索引
db.itineraries.createIndex({ "_id": 1 })

// 用户行程索引
db.itineraries.createIndex({ 
  "userId": 1, 
  "createdAt": -1 
})

// 目的地查询索引
db.itineraries.createIndex({ 
  "tripInfo.destination": 1, 
  "status": 1 
})

// 日期范围查询索引
db.itineraries.createIndex({ 
  "tripInfo.startDate": 1, 
  "tripInfo.endDate": 1 
})

// 状态查询索引
db.itineraries.createIndex({ 
  "status": 1, 
  "updatedAt": -1 
})

// 预算范围查询索引
db.itineraries.createIndex({ 
  "tripInfo.budget.total": 1, 
  "tripInfo.duration": 1 
})

// 复合索引 - 推荐查询
db.itineraries.createIndex({ 
  "tripInfo.destination": 1, 
  "tripInfo.travelStyle": 1, 
  "status": 1 
})

// 文本索引 - 搜索功能
db.itineraries.createIndex({ 
  "title": "text", 
  "description": "text", 
  "tripInfo.destination": "text" 
})
```

### 4. 景点集合 (attractions)

#### 集合结构
```javascript
{
  _id: ObjectId,
  attractionId: String,              // 景点唯一标识
  name: String,                      // 景点名称
  nameEn: String,                    // 英文名称
  category: String,                  // 类别: museum, park, landmark, restaurant, etc.
  subcategory: String,               // 子类别
  
  // 位置信息
  location: {
    lat: Number,                     // 纬度
    lng: Number,                     // 经度
    address: String,                 // 地址
    city: String,                    // 城市
    province: String,                // 省份
    country: String,                 // 国家
    postalCode: String,              // 邮编
    placeId: String                  // 地点ID
  },
  
  // 基本信息
  basicInfo: {
    description: String,             // 描述
    shortDescription: String,        // 简短描述
    openingHours: [{
      day: String,                   // 星期几
      open: String,                  // 开门时间
      close: String,                 // 关门时间
      isOpen: Boolean                // 是否营业
    }],
    phone: String,                   // 电话
    website: String,                 // 网站
    email: String,                   // 邮箱
    price: {
      amount: Number,                // 价格
      currency: String,              // 货币
      type: String                   // 价格类型: free, paid, donation
    },
    duration: Number,                // 建议游览时长(分钟)
    capacity: Number,                // 容量
    ageRestriction: {
      min: Number,                   // 最小年龄
      max: Number                    // 最大年龄
    }
  },
  
  // 评分和评论
  ratings: {
    average: Number,                 // 平均评分
    count: Number,                   // 评分数量
    distribution: {                  // 评分分布
      "1": Number,
      "2": Number,
      "3": Number,
      "4": Number,
      "5": Number
    },
    recentReviews: [{
      userId: ObjectId,              // 用户ID
      rating: Number,                // 评分
      comment: String,               // 评论
      date: Date,                    // 评论日期
      helpful: Number                // 有用数
    }]
  },
  
  // 媒体资源
  media: {
    images: [{
      url: String,                   // 图片URL
      caption: String,               // 图片说明
      type: String,                  // 图片类型: main, gallery, thumbnail
      width: Number,                 // 宽度
      height: Number                 // 高度
    }],
    videos: [{
      url: String,                   // 视频URL
      caption: String,               // 视频说明
      duration: Number,              // 时长(秒)
      thumbnail: String              // 缩略图URL
    }],
    virtualTour: String              // 虚拟导览URL
  },
  
  // 特色和设施
  features: {
    tags: [String],                  // 标签
    amenities: [String],             // 设施
    accessibility: [String],         // 无障碍设施
    languages: [String],             // 支持语言
    paymentMethods: [String],        // 支付方式
    parking: {
      available: Boolean,            // 是否有停车场
      type: String,                  // 停车类型: free, paid, valet
      cost: Number                   // 停车费用
    }
  },
  
  // 季节性信息
  seasonalInfo: {
    bestTime: [String],              // 最佳时间
    peakSeason: {
      start: String,                 // 旺季开始
      end: String                    // 旺季结束
    },
    weatherConsiderations: String,   // 天气考虑
    specialEvents: [{
      name: String,                  // 活动名称
      date: String,                  // 活动日期
      description: String            // 活动描述
    }]
  },
  
  // 推荐信息
  recommendations: {
    similarAttractions: [ObjectId],  // 相似景点
    nearbyAttractions: [ObjectId],   // 附近景点
    popularCombinations: [ObjectId], // 热门组合
    userRecommendations: [{
      userId: ObjectId,              // 用户ID
      reason: String,                // 推荐理由
      date: Date                     // 推荐日期
    }]
  },
  
  // 统计数据
  statistics: {
    viewCount: Number,               // 浏览次数
    favoriteCount: Number,           // 收藏次数
    visitCount: Number,              // 访问次数
    averageVisitDuration: Number,    // 平均访问时长
    popularTimes: [{
      day: String,                   // 星期几
      hour: Number,                  // 小时
      popularity: Number             // 热门程度(0-100)
    }]
  },
  
  // 系统字段
  createdAt: Date,
  updatedAt: Date,
  lastVerified: Date,                // 最后验证时间
  isActive: Boolean,                 // 是否活跃
  source: String,                    // 数据来源
  version: Number                    // 版本号
}
```

#### 索引设计
```javascript
// 主键索引
db.attractions.createIndex({ "_id": 1 })

// 景点ID索引
db.attractions.createIndex({ "attractionId": 1 }, { unique: true })

// 地理位置索引
db.attractions.createIndex({ 
  "location": "2dsphere" 
})

// 城市查询索引
db.attractions.createIndex({ 
  "location.city": 1, 
  "category": 1 
})

// 类别查询索引
db.attractions.createIndex({ 
  "category": 1, 
  "subcategory": 1 
})

// 评分查询索引
db.attractions.createIndex({ 
  "ratings.average": -1, 
  "ratings.count": -1 
})

// 价格查询索引
db.attractions.createIndex({ 
  "basicInfo.price.amount": 1, 
  "basicInfo.price.type": 1 
})

// 标签查询索引
db.attractions.createIndex({ 
  "features.tags": 1 
})

// 文本搜索索引
db.attractions.createIndex({ 
  "name": "text", 
  "nameEn": "text", 
  "basicInfo.description": "text" 
})

// 复合索引 - 推荐查询
db.attractions.createIndex({ 
  "location.city": 1, 
  "category": 1, 
  "ratings.average": -1, 
  "isActive": 1 
})
```

## 🔄 Redis缓存设计

### 1. 缓存策略

#### 缓存层级
```javascript
// L1缓存 - 内存缓存 (应用层)
const memoryCache = new Map();

// L2缓存 - Redis缓存 (分布式缓存)
const redisClient = redis.createClient();

// L3缓存 - 数据库 (持久化存储)
const mongoClient = new MongoClient();
```

#### 缓存键设计
```javascript
// 用户信息缓存
const userCacheKey = `user:${userId}`;
const userProfileCacheKey = `user:${userId}:profile`;

// 会话缓存
const sessionCacheKey = `session:${sessionId}`;
const conversationCacheKey = `conversation:${sessionId}`;

// 行程缓存
const itineraryCacheKey = `itinerary:${itineraryId}`;
const userItinerariesCacheKey = `user:${userId}:itineraries`;

// 景点缓存
const attractionCacheKey = `attraction:${attractionId}`;
const attractionsByCityCacheKey = `attractions:city:${city}`;
const attractionsByCategoryCacheKey = `attractions:category:${category}`;

// 推荐缓存
const recommendationsCacheKey = `recommendations:${userId}:${location}`;
const popularAttractionsCacheKey = `popular:attractions:${city}`;

// 天气缓存
const weatherCacheKey = `weather:${city}:${date}`;

// 路线缓存
const routeCacheKey = `route:${startPoint}:${endPoint}:${mode}`;
```

### 2. 缓存数据结构

#### 用户会话缓存
```javascript
// Redis Hash结构
{
  "session:abc123": {
    "userId": "user123",
    "sessionId": "abc123",
    "startTime": "2024-12-01T10:00:00Z",
    "lastActivity": "2024-12-01T10:30:00Z",
    "messageCount": "15",
    "currentIntent": "plan_trip",
    "planningStage": "destination_selection",
    "extractedEntities": '{"location": ["北京"], "duration": ["3天"]}',
    "userPreferences": '{"travelStyle": "budget", "budgetRange": {"min": 1000, "max": 5000}}'
  }
}
```

#### 对话消息缓存
```javascript
// Redis List结构
{
  "conversation:abc123": [
    '{"role": "user", "content": "我想去北京旅游", "timestamp": "2024-12-01T10:00:00Z"}',
    '{"role": "assistant", "content": "好的，我来帮您规划北京之旅", "timestamp": "2024-12-01T10:00:05Z"}',
    '{"role": "user", "content": "预算3000元", "timestamp": "2024-12-01T10:01:00Z"}'
  ]
}
```

#### 景点信息缓存
```javascript
// Redis Hash结构
{
  "attraction:beijing_forbidden_city": {
    "id": "beijing_forbidden_city",
    "name": "故宫博物院",
    "category": "museum",
    "location": '{"lat": 39.9163, "lng": 116.3972, "city": "北京"}',
    "rating": "4.8",
    "price": "60",
    "openingHours": '{"monday": {"open": "08:30", "close": "17:00"}}',
    "description": "中国明清两代的皇家宫殿",
    "images": '["image1.jpg", "image2.jpg"]',
    "tags": '["历史", "文化", "建筑"]'
  }
}
```

#### 推荐结果缓存
```javascript
// Redis Sorted Set结构
{
  "recommendations:user123:beijing": [
    {"score": "0.95", "member": "attraction:beijing_forbidden_city"},
    {"score": "0.92", "member": "attraction:beijing_summer_palace"},
    {"score": "0.88", "member": "attraction:beijing_temple_of_heaven"}
  ]
}
```

### 3. 缓存管理策略

#### TTL设置
```javascript
const CACHE_TTL = {
  // 短期缓存 (5分钟)
  SHORT: 300,
  
  // 中期缓存 (1小时)
  MEDIUM: 3600,
  
  // 长期缓存 (24小时)
  LONG: 86400,
  
  // 超长期缓存 (7天)
  EXTENDED: 604800,
  
  // 具体业务TTL
  USER_SESSION: 1800,           // 30分钟
  CONVERSATION: 3600,           // 1小时
  ITINERARY: 86400,             // 24小时
  ATTRACTION: 604800,           // 7天
  RECOMMENDATIONS: 3600,        // 1小时
  WEATHER: 1800,                // 30分钟
  ROUTE: 3600                   // 1小时
};
```

#### 缓存更新策略
```javascript
class CacheManager {
  // 写入时更新缓存
  async updateCache(key: string, data: any, ttl: number): Promise<void> {
    await this.redis.setex(key, ttl, JSON.stringify(data));
  }
  
  // 删除缓存
  async invalidateCache(pattern: string): Promise<void> {
    const keys = await this.redis.keys(pattern);
    if (keys.length > 0) {
      await this.redis.del(...keys);
    }
  }
  
  // 批量更新缓存
  async batchUpdateCache(updates: Array<{key: string, data: any, ttl: number}>): Promise<void> {
    const pipeline = this.redis.pipeline();
    
    updates.forEach(({key, data, ttl}) => {
      pipeline.setex(key, ttl, JSON.stringify(data));
    });
    
    await pipeline.exec();
  }
  
  // 缓存预热
  async warmupCache(): Promise<void> {
    // 预热热门景点
    const popularAttractions = await this.getPopularAttractions();
    await this.updateCache('popular:attractions', popularAttractions, CACHE_TTL.LONG);
    
    // 预热城市信息
    const cities = await this.getCities();
    await this.updateCache('cities:list', cities, CACHE_TTL.EXTENDED);
  }
}
```

#### 缓存一致性
```javascript
class CacheConsistencyManager {
  // 数据库更新时同步缓存
  async syncCacheOnUpdate(collection: string, documentId: string): Promise<void> {
    const cacheKey = `${collection}:${documentId}`;
    
    // 删除相关缓存
    await this.cacheManager.invalidateCache(cacheKey);
    
    // 删除相关查询缓存
    const relatedPatterns = this.getRelatedCachePatterns(collection, documentId);
    for (const pattern of relatedPatterns) {
      await this.cacheManager.invalidateCache(pattern);
    }
  }
  
  // 获取相关缓存模式
  private getRelatedCachePatterns(collection: string, documentId: string): string[] {
    const patterns = [];
    
    switch (collection) {
      case 'users':
        patterns.push(`user:${documentId}:*`);
        patterns.push(`recommendations:${documentId}:*`);
        break;
      case 'itineraries':
        patterns.push(`itinerary:${documentId}`);
        patterns.push(`user:*:itineraries`);
        break;
      case 'attractions':
        patterns.push(`attraction:${documentId}`);
        patterns.push(`attractions:city:*`);
        patterns.push(`attractions:category:*`);
        patterns.push(`popular:attractions:*`);
        break;
    }
    
    return patterns;
  }
}
```

## 📈 性能优化

### 1. 数据库优化

#### 查询优化
```javascript
// 使用聚合管道优化复杂查询
const optimizedQuery = db.itineraries.aggregate([
  // 匹配条件
  { $match: { 
    userId: ObjectId(userId),
    status: { $in: ['confirmed', 'completed'] }
  }},
  
  // 关联用户信息
  { $lookup: {
    from: 'users',
    localField: 'userId',
    foreignField: '_id',
    as: 'user'
  }},
  
  // 展开用户数组
  { $unwind: '$user' },
  
  // 投影需要的字段
  { $project: {
    title: 1,
    destination: '$tripInfo.destination',
    startDate: '$tripInfo.startDate',
    endDate: '$tripInfo.endDate',
    budget: '$tripInfo.budget.total',
    username: '$user.username'
  }},
  
  // 排序
  { $sort: { startDate: -1 }},
  
  // 限制结果数量
  { $limit: 20 }
]);
```

#### 索引优化
```javascript
// 复合索引优化
db.itineraries.createIndex({
  "userId": 1,
  "status": 1,
  "tripInfo.startDate": -1
}, { background: true });

// 部分索引 - 只索引活跃用户
db.users.createIndex(
  { "status": 1, "lastActiveAt": -1 },
  { 
    partialFilterExpression: { status: "active" },
    background: true 
  }
);

// 稀疏索引 - 只索引有值的字段
db.attractions.createIndex(
  { "basicInfo.phone": 1 },
  { sparse: true, background: true }
);
```

### 2. 缓存优化

#### 缓存命中率优化
```javascript
class CacheOptimizer {
  // 预测性缓存
  async predictiveCache(userId: string): Promise<void> {
    const userBehavior = await this.analyzeUserBehavior(userId);
    
    // 缓存用户可能访问的数据
    if (userBehavior.frequentlySearchedCities.length > 0) {
      for (const city of userBehavior.frequentlySearchedCities) {
        await this.cacheCityAttractions(city);
      }
    }
    
    // 缓存用户偏好的景点类别
    if (userBehavior.preferredCategories.length > 0) {
      for (const category of userBehavior.preferredCategories) {
        await this.cacheCategoryAttractions(category);
      }
    }
  }
  
  // 智能缓存失效
  async smartCacheInvalidation(changeType: string, data: any): Promise<void> {
    switch (changeType) {
      case 'user_preference_update':
        await this.invalidateUserRecommendations(data.userId);
        break;
      case 'attraction_update':
        await this.invalidateAttractionCache(data.attractionId);
        await this.invalidateRelatedCaches(data.attractionId);
        break;
      case 'itinerary_update':
        await this.invalidateItineraryCache(data.itineraryId);
        await this.invalidateUserItineraries(data.userId);
        break;
    }
  }
}
```

---

**文档版本**: v1.0  
**最后更新**: 2024年12月  
**维护者**: 数据库设计团队 